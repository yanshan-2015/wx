$(function(){function e(){wx.uploadVoice({localId:c.localId,isShowProgressTips:1,success:function(e){c.serverId=e.serverId}})}$(".phone span").click(function(){$(this).siblings("input").val("")}),$(".direct").css({height:FH()});var t=FH(),a=$(".contain").height();(a>t||a==t)&&$(".direct").css({position:"static",height:"auto"});var c={localId:"",serverId:""},i=location.href.split("#")[0];$.ajax({type:"get",url:"http://zs.derucci.net:8821/deruccimid/antifake/getweichatcfg",jsonp:"jsoncallback",dataType:"jsonp",data:{url:i},success:function(t){console.log(t),wx.config({debug:!1,appId:"wx879c920191311570",timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["startRecord","stopRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice"]}),wx.error(function(e){}),wx.ready(function(){wx.checkJsApi({jsApiList:["startRecord","stopRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice"],success:function(t){$(".voice").click(function(){function t(e){i.beginPath(),i.moveTo(n/2,o/2),i.arc(n/2,o/2,o/2,0,2*Math.PI,!1),i.fillStyle="#ff6100",i.closePath(),i.fill(),i.beginPath(),i.moveTo(n/2,o/2),i.arc(n/2,o/2,o/2-10,0,2*Math.PI,!1),i.fillStyle="#444",i.closePath(),i.fill(),i.font="bold 26px Arial",i.fillStyle="#fff",i.textAlign="center",i.textBaseline="middle",i.moveTo(n/2,o/2),i.fillText("长按录音",n/2,o/2),i.beginPath(),i.arc(n/2,o/2,o/2-5,-Math.PI/2,2*Math.PI*e-Math.PI/2,!1),i.strokeStyle=r,i.lineWidth=10,i.stroke()}$(".voiceCover").show();var a=document.getElementById("circle"),i=a.getContext("2d"),n=a.width,o=a.height,r="#6aee35";t(0),$("#circle").on("touchstart",function(a){a.preventDefault(),START=(new Date).getTime(),wx.startRecord();var i=0;!function(a){timer=setInterval(function(){if(i>a)return clearInterval(timer),wx.stopRecord({success:function(t){c.localId=t.localId,e()},fail:function(e){alert(JSON.stringify(e))}}),!1;i+=.001,t(i)},15)}(1)}),$("#circle").on("touchend",function(a){if(a.preventDefault(),END=(new Date).getTime(),END-START<1e3)return END=0,START=0,alert("录音不能少于1秒"),clearInterval(timer),t(0),!1;clearInterval(timer),wx.stopRecord({success:function(t){c.localId=t.localId,e()},fail:function(e){alert("录音完毕自动暂停")}})}),$(".voiceCover span").click(function(){$("#circle").unbind("touchstart"),$("#circle").unbind("touchend"),t(0),i.clearRect(0,0,n,o),wx.stopVoice({localId:c.localId}),$(".voiceCover").hide()}),$(".play").click(function(){if(""==c.localId)return void alert("请先录音");wx.playVoice({localId:c.localId})}),$(".stop").click(function(){wx.stopVoice({localId:c.localId})})})}})})},error:function(){console.log("Ajax error")}});var n=new Object,o=new Object,r=new Object,s=new Object;$(".star span").click(function(){$(this).parent().children().removeClass("actives");var e=$(this).index(),t=$(this).parents(".starLs").find("p").attr("class");console.log(t);var a=e+1;switch(t){case"check1":n.star=a;break;case"check2":o.star=a;break;case"check3":r.star=a;break;case"check4":s.star=a}for(var c=$(this).parent().children(),i=0;i<e+1;i++)c[i].className="actives";$.each($(".starLs span"),function(){if(-1==this.className.indexOf("actives"))return $(".stableLs").show(),!1;$(".stableLs").hide()})});var l=new Object;l.text=$(".stableLs .active").text(),$(".stableLs li").click(function(){$(".stableLs li").removeClass("active"),$(this).addClass("active"),l.text=$(this).text()}),PreView(),$(".submit").click(function(){if(console.log(n.star),void 0==n.star||void 0==o.star||void 0==o.star||void 0==r.star||"undefined"==s.star)return alert("星级评价有遗漏哦~"),!1;var e=new FormData($("#myForm")[0]);e.append("barCode","测试"),e.append("weichatNum","测试"),e.append("telphone",$("#phone").val()),e.append("jingdu","不知道"),e.append("weidu","不知道"),e.append("xsfwLeave",n.star),e.append("azfwLeave",o.star),e.append("cpLeave",r.star),e.append("ztLeave",s.star),e.append("remark",l.text),e.append("status","这个是什么？"),$.ajax({type:"POST",url:"http://zs.derucci.net:8821/deruccimid/antifake/savefeedback",data:e,async:!1,processData:!1,contentType:!1,success:function(e){if(console.log(e),1==e.success){var t=e.obj.pic;$(".cover").css({height:$(".direct").height()}).show(),$(".btn").click(function(){5==n.star&&5==o.star&&5==o.star&&5==r.star&&5==s.star?location.href="share.html?pic="+t:location.href="index.html"})}},error:function(){alert("提交失败，请重试")}})})});var FH=function(){return this.height=document.documentElement.clientHeight,this.height},PreView=function(){$("#choseFile").change(function(e){for(var t=e.target.files,a=/^image\//,c=0,i=t.length;c<i;c++){var n=t[c];if(!a.test(n.type))return alert("请选择图片！"),!1;if(n.size>20971520)return alert("当前图片大于20M"),!1;var o=$("<li></li>"),r=$("<img class='obj' file="+n+">");if(!window.FileReader)return alert("你的设备不支持预览"),!1;var s=new FileReader;s.onload=function(e){return function(t){e.attr("src",t.target.result)}}(r),o.append(r),$(".imgList").prepend(o),s.readAsDataURL(n)}})};