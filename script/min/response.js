Zepto(function(e){var t={phone:getQueryString("phone"),jingdu:getQueryString("jingdu"),weidu:getQueryString("weidu")};e("#phone").val(t.phone);var c={localId:"",serverId:"",current:0},a=null,n=location.href.split("#")[0];e.ajax({type:"get",url:"http://zs.derucci.net:8821/deruccimid/antifake/getweichatcfg",jsonp:"jsoncallback",dataType:"jsonp",data:{url:n},success:function(t){wx.config({debug:!1,appId:"wx879c920191311570",timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["startRecord","stopRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice"]}),wx.error(function(e){}),wx.ready(function(){function t(){wx.uploadVoice({localId:c.localId,isShowProgressTips:1,success:function(e){c.serverId=e.serverId}})}wx.checkJsApi({jsApiList:["startRecord","stopRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice"],success:function(n){e(".voice").click(function(){function n(e){r.beginPath(),r.moveTo(o/2,s/2),r.arc(o/2,s/2,s/2,0,2*Math.PI,!1),r.fillStyle="#ff6100",r.closePath(),r.fill(),r.beginPath(),r.moveTo(o/2,s/2),r.arc(o/2,s/2,s/2-10,0,2*Math.PI,!1),r.fillStyle="#444",r.closePath(),r.fill(),r.font="bold 26px Arial",r.fillStyle="#fff",r.textAlign="center",r.textBaseline="middle",r.moveTo(o/2,s/2),r.fillText("长按录音",o/2,s/2),r.beginPath(),r.arc(o/2,s/2,s/2-5,-Math.PI/2,2*Math.PI*e-Math.PI/2,!1),r.strokeStyle=l,r.lineWidth=10,r.stroke()}e(".voiceCover").show(),wx.startRecord({success:function(e){wx.stopRecord()},fail:function(t){alert("您拒绝了录音"),e("#circle").unbind("touchstart")}});var i=document.getElementById("circle"),r=i.getContext("2d"),o=i.width,s=i.height,l="#6aee35";n(0),e("#circle").on("touchstart",function(e){if(e.preventDefault(),1==c.current)return alert("正在播放语音..."),!1;START=(new Date).getTime(),wx.startRecord();var i=0;!function(e){a=setInterval(function(){if(i>e)return clearInterval(a),wx.stopRecord({success:function(e){c.localId=e.localId,t()},fail:function(e){alert(JSON.stringify(e))}}),!1;i+=.001,n(i)},15)}(1)}),e("#circle").on("touchend",function(e){if(e.preventDefault(),END=(new Date).getTime(),END-START<1e3)return END=0,START=0,alert("录音不能少于1秒"),clearInterval(a),n(0),wx.stopRecord(),!1;clearInterval(a),wx.stopRecord({success:function(e){c.localId=e.localId,t()},fail:function(e){alert("录音完毕自动暂停")}})}),e(".voiceCover span").click(function(){wx.stopVoice({localId:c.localId}),e("#circle").unbind("touchstart"),e("#circle").unbind("touchend"),n(0),clearInterval(a),r.clearRect(0,0,o,s),e(".voiceCover").hide()})}),e(".play").click(function(){if(""==c.localId)return alert("请先录音"),!1;c.current=1,wx.playVoice({localId:c.localId}),wx.onVoicePlayEnd({success:function(e){c.current=0}})}),e(".stop").click(function(){wx.stopVoice({localId:c.localId}),c.current=0})}})})},error:function(){console.log("Ajax error")}}),e(".response").css({height:FH()});var i=FH(),r=e(".contain").height();(r>i||r==i)&&e(".response").css({position:"static",height:"auto"});var o=new Object,s=new Object,l=new Object,d=new Object;e(".star span").click(function(){e(this).parent().children().removeClass("actives");var t=e(this).index(),c=e(this).parents(".starLs").find("p").attr("class"),a=t+1;switch(c){case"check1":o.star=a;break;case"check2":s.star=a;break;case"check3":l.star=a;break;case"check4":d.star=a}for(var n=e(this).parent().children(),i=0;i<t+1;i++)n[i].className="actives";e.each(e(".starLs span"),function(){if(-1==this.className.indexOf("actives"))return e(".stableLs").show(),!1;e(".stableLs").hide()})});var u=new Object;u.text=e(".stableLs .active").text(),e(".stableLs li").click(function(){e(".stableLs li").removeClass("active"),e(this).addClass("active"),u.text=e(this).text()}),PreView(),e(".submit").click(function(){if(void 0==o.star||void 0==s.star||void 0==s.star||void 0==l.star||"undefined"==d.star)return alert("星级评价有遗漏哦~"),!1;var a=new FormData(e("#myForm")[0]);a.append("telphone",t.phone),a.append("jingdu",t.jingdu),a.append("weidu",t.weidu),a.append("xsfwLeave",o.star),a.append("azfwLeave",s.star),a.append("cpLeave",l.star),a.append("ztLeave",d.star),a.append("remark",u.text),a.append("status","这个是什么？"),a.append("vedio",c.serverId),e.ajax({type:"POST",url:"http://zs.derucci.net:8821/deruccimid/antifake/savefeedback",data:a,async:!1,processData:!1,contentType:!1,success:function(t){if(console.log(t),1==t.success){var c=t.obj.pic;e(".cover").css({height:e(".response").height()}).show(),e(".btn").click(function(){5==o.star&&5==s.star&&5==s.star&&5==l.star&&5==d.star?location.href="share.html?pic="+c:location.href="index.html"})}},error:function(){alert("提交失败，请重试")}})})});var FH=function(){return this.height=document.documentElement.clientHeight,this.height},PreView=function(){$("#choseFile").change(function(e){var t=e.target.files;console.log(t);for(var c=/^image\//,a=0,n=t.length;a<n;a++){var i=t[a];if(!c.test(i.type))return alert("请选择图片！"),!1;if(i.size>20971520)return alert("当前图片大于20M"),!1;var r=$("<li></li>"),o=$("<img class='obj' file="+i+">");if(!window.FileReader)return alert("你的设备不支持预览"),!1;var s=new FileReader;s.onload=function(e){return function(t){e.attr("src",t.target.result)}}(o),r.append(o),$(".imgList").prepend(r),s.readAsDataURL(i)}})};